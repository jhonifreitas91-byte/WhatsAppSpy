document.addEventListener("DOMContentLoaded", () => {

    const progress = document.querySelector(".progress");
    const progressBar = document.querySelector(".progress-bar");
    const progressText = document.querySelectorAll(".progress-text");
    const statusText = document.getElementById("statusText");
    const statusIcon = document.getElementById("statusIcon");

    const btnUnderVsl = document.querySelector(".btn-under-vsl");

    const cardMsg = document.getElementById("card-msg");
    const cardImg = document.getElementById("card-img");
    const cardLoc = document.getElementById("card-loc");

    let progressValue = 0;
    let lastPct = -1;

    const TOTAL_TIME = 28000; // 28 segundos
    const startTime = performance.now();

    function updateStatus(text, icon) {
        statusText.classList.remove("changing");
        void statusText.offsetWidth;
        statusText.textContent = text;
        statusIcon.textContent = icon;
        statusText.classList.add("changing");
    }

    function tick(now) {
        const elapsed = now - startTime;
        const pct = Math.min(100, Math.floor((elapsed / TOTAL_TIME) * 100));

        if (pct === lastPct) {
            requestAnimationFrame(tick);
            return;
        }
        lastPct = pct;

        // === BARRA ===
        progressBar.style.width = pct + "%";
        progress.setAttribute("data-width", pct + "%");
        progressText.forEach(el => el.textContent = pct + "%");

        // === STATUS TEXTO ===
        if (pct < 20) updateStatus("Iniciando anÃ¡lise...", "ðŸ”");
        else if (pct < 40) updateStatus("Conectando ao dispositivo...", "ðŸ“¡");
        else if (pct < 60) updateStatus("Analisando mensagens...", "ðŸ’¬");
        else if (pct < 80) updateStatus("Verificando imagens...", "ðŸ–¼ï¸");
        else if (pct < 95) updateStatus("Mapeando localizaÃ§Ãµes...", "ðŸ“");
        else updateStatus("AnÃ¡lise concluÃ­da!", "âœ…");

        // === CARDS ===
        if (pct >= 20) cardMsg.classList.add("processing");
        if (pct >= 50) {
            cardMsg.classList.remove("processing");
            cardMsg.classList.add("completed");
            cardMsg.querySelector(".card-result").style.display = "flex";
        }

        if (pct >= 55) cardImg.classList.add("processing");
        if (pct >= 75) {
            cardImg.classList.remove("processing");
            cardImg.classList.add("completed");
            cardImg.querySelector(".card-result").style.display = "flex";
        }

        if (pct >= 80) cardLoc.classList.add("processing");
        if (pct >= 95) {
            cardLoc.classList.remove("processing");
            cardLoc.classList.add("completed");
            cardLoc.querySelector(".card-result").style.display = "flex";
        }

        // === BOTÃƒO ===
        if (pct >= 100) {
            btnUnderVsl.style.display = "block";
        }

        if (pct < 100) {
            requestAnimationFrame(tick);
        }
    }

    requestAnimationFrame(tick);
});
